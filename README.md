#Data Processing System using Prefect 3.0

Данное приложение предназначено для обработки данных из CSV-файла, после чего сохраняет их в формате JSON, а после выполнения - присылает соответствующее уведомление в Telegram.

#Функционал.
- Загрузка данных из CSV-файла.
- Для каждой строки выполняется запрос к стороннему API.
- Обработка полученных данных с использованием pandas.
- Сохранение результатов в JSON-файлы.
- Отправка уведомления о завершении обработки в Telegram чат.

Требования:
- Docker
- Python 3.9+
- Prefect 3.0+
- Pandas
- Requests

Инструкция по запуску:

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/barkozzer/test_task_CSV_JSON.git
   cd your-repository

2. Отредактируйте переменные: 
    •	file_path: путь к вашему CSV-файлу.
    •	output_dir: директория для сохранения выходных JSON-файлов.
    •	chat_id: ваш Chat ID в Telegram.
    •	bot_token: токен вашего бота.

3. Соберите Docker-образ:
   ```bash
   docker build -t data_processing_app .

4. Запустите Prefect сервер:
   ```bash
   docker run -d -p 4200:4200 data_processing_app

5. Настройте и запустите воркер:
   ```bash
   prefect work-pool create "default" --type process

6. Чтобы запустить деплоймент:
   ```bash
   prefect deploy /path/to/data_flow.py:data_processing_flow -n "Data Processing Flow" -p default -q default

7. Для запуска пропишите в терминале (перед этим создайте Telegram-бота через BotFather, чтобы получить токен и ID вашего с ним чата):
   ```bash
   prefect deployment run "Data Processing Flow/Data Processing Flow" \
   -p file_path="path_to_CSV" \
   -p output_dir="path_to_result" \
   -p chat_id="chat_id" \
   -p bot_token="token"

8. Запустите Prefect UI по адресу http://127.0.0.1:4200

9. После того, как процесс будет закончен - вы получите уведомление об этом в Telegram.

#Архитектура и принятые решения.
Архитектура решения

1. **Основной поток данных (Flow)** выполняет обработку данных по следующим этапам:
   - Загрузка данных из CSV.
   - В каждой строке файла делается запрос к стороннему API для получения данных.
   - Данные обрабатываются с помощью pandas.
   - Результаты сохраняются в формате JSON.
   - После того, как процесс завершится - отправляется уведомление в Telegram.

2. **Задачи (Tasks)**: Поток состоит из нескольких задач:
   - `load_csv`: Загружает данные из CSV.
   - `fetch_data_from_api`: Выполняет запрос к API на основе CSV.
   - `process_data`: Преобразует ответ API.
   - `save_to_json`: Сохраняет результат в JSON-файлы.
   - `send_telegram_notification`: Отправляет уведомление в Telegram.

3. **Использование Prefect**:
   - **Flow и Tasks** были построены с использованием Prefect для управления выполнением задач и обработки ошибок.
   - **Prefect Deployment** позволяет запускать поток данных на основе конфигурации в YAML-файле. 
   - **Prefect UI** используется для мониторинга выполнения задач.

#Принятые решения

1. **Лимиты и ограничения worker'ов**:
   - **Частота выполнения задач**: Установлена задержка в 30 секунд перед выполнением каждого API-запроса с помощью команды `time.sleep(30)` не чаще, чем 1 раз в 30 секунд.

2. **Prefect Concurrency Limit**:
   - Чтобы предотвратить перегрузку API или системы, мы настроили глобальные лимиты выполнения задач в деплойменте. Лимиты включают ограничения по параллельным запросам и ресурсу CPU через Prefect UI.

3. **Логирование и мониторинг**:
   - Логирование реализовано с использованием `get_run_logger()`, что позволяет отслеживать каждый этап обработки данных.
   - Результаты обработки сохраняются в виде артефактов через Prefect Artifacts, что позволяет отслеживать и видеть результаты в UI.

Дополнительно:

- **Использован Prefect Artifacts**: В проекте настроена визуализация данных через артефакты Prefect.

#Примечание.
В случае, если терминал не синхронизировался с Prefect, но необходимо прописать в терминале, после чего вы сможете работать с Prefect UI через терминал и интерпретатор:
   ```bash
   export PREFECT_API_URL=http://127.0.0.1:4200/api